üìä Zabbix Proxy 7.0 LTS - Manual de Instala√ß√£o

[![Zabbix](https://img.shields.io/badge/Zabbix-7.0-red?style=for-the-badge&logo=zabbix)](https://www.zabbix.com/)
[![MySQL](https://img.shields.io/badge/MySQL-8.0-blue?style=for-the-badge&logo=mysql)](https://www.mysql.com/)
[![Ubuntu](https://img.shields.io/badge/Ubuntu-24.04-orange?style=for-the-badge&logo=ubuntu)](https://ubuntu.com/)

> **Manual T√©cnico**: Implementa√ß√£o completa de Zabbix Proxy 7.0 LTS + MySQL no Ubuntu Server 24.04 LTS

## üìã √çndice

- [üéØ Objetivo e Pr√©-requisitos](#-objetivo-e-pr√©-requisitos)
- [üöÄ Prepara√ß√£o do Ambiente](#-prepara√ß√£o-do-ambiente)
- [üîß Instala√ß√£o dos Componentes](#-instala√ß√£o-dos-componentes)
- [üóÑÔ∏è Configura√ß√£o do Banco de Dados](#Ô∏è-configura√ß√£o-do-banco-de-dados)
- [‚öôÔ∏è Configura√ß√£o do Zabbix Proxy](#Ô∏è-configura√ß√£o-do-zabbix-proxy)
- [üöÄ Inicializa√ß√£o dos Servi√ßos](#-inicializa√ß√£o-dos-servi√ßos)
- [‚úÖ Verifica√ß√µes P√≥s-Instala√ß√£o](#-verifica√ß√µes-p√≥s-instala√ß√£o)
- [üîó Configura√ß√£o no Zabbix Server](#-configura√ß√£o-no-zabbix-server)
- [üî• Configura√ß√£o de Firewall](#-configura√ß√£o-de-firewall)
- [üìä Monitoramento e Troubleshooting](#-monitoramento-e-troubleshooting)
- [üõ†Ô∏è Manuten√ß√£o](#Ô∏è-manuten√ß√£o)
- [üìö Refer√™ncias](#-refer√™ncias)

## üéØ Objetivo e Pr√©-requisitos

### Objetivo

Implementar um Zabbix Proxy para distribuir a carga de monitoramento e melhorar a performance em ambientes distribu√≠dos, proporcionando coleta de dados local e sincroniza√ß√£o com o Zabbix Server central.

### Pr√©-requisitos

| Componente | Especifica√ß√£o |
|------------|---------------|
| **Sistema Operacional** | Ubuntu Server 24.04 LTS |
| **RAM** | M√≠nimo 1GB (Recomendado 2GB+) |
| **CPU** | M√≠nimo 1 vCPU (Recomendado 2+) |
| **Storage** | M√≠nimo 10GB (Recomendado 20GB+) |
| **Acesso** | Root ou usu√°rio com sudo |
| **Conectividade** | Internet + acesso ao Zabbix Server |
| **Portas** | 10051 (proxy), 3306 (mysql) |

### Arquitetura da Solu√ß√£o

```mermaid
graph LR
    A[Zabbix Server<br/>Central] <--> B[Zabbix Proxy<br/>Collector]
    B <--> C[MySQL<br/>Local DB]
    B <--> D[Monitored<br/>Hosts/Agents]
    
    A -.->|Port 10051| B
    B -.->|Port 3306| C
    B -.->|Port 10050| D
```

## üöÄ Prepara√ß√£o do Ambiente

### Atualiza√ß√£o do sistema
```bash
# Atualizar lista de pacotes e sistema
sudo apt update && sudo apt upgrade -y

# Verificar vers√£o do sistema
lsb_release -a
```

### Instalar Depend√™ncias

```bash
# Instalar ferramentas essenciais
sudo apt install -y wget curl gnupg2 lsb-release software-properties-common
```

### Configurar Reposit√≥rio Zabbix

```bash
# Download do pacote de release do Zabbix 7.0
wget https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.0+ubuntu24.04_all.deb

# Instala√ß√£o do reposit√≥rio
sudo dpkg -i zabbix-release_latest_7.0+ubuntu24.04_all.deb

# Atualiza√ß√£o do cache de pacotes
sudo apt update

# Limpeza do arquivo tempor√°rio
rm zabbix-release_latest_7.0+ubuntu24.04_all.deb
```

## üîß Instala√ß√£o dos Componentes

### Instalar MySQL Server

```bash
# Instala√ß√£o do MySQL Server e cliente
sudo apt install -y mysql-server mysql-client

# Verificar status do servi√ßo
sudo systemctl status mysql
```

### Configura√ß√£o de Seguran√ßa do MySQL
```bash
# Executar script de configura√ß√£o segura
sudo mysql_secure_installation
```

> **‚ö†Ô∏è Configura√ß√µes recomendadas durante mysql_secure_installation:**
> - Validate Password Plugin: **Y** (Yes)
> - Password Validation Policy: **2** (STRONG)
> - Remove anonymous users: **Y** (Yes)
> - Disallow root login remotely: **Y** (Yes)
> - Remove test database: **Y** (Yes)
> - Reload privilege tables: **Y** (Yes)

### Instalar Zabbix Proxy e Depend√™ncias

```bash
## Instala√ß√£o dos componentes principais
sudo apt install -y \
    zabbix-proxy-mysql \
    zabbix-sql-scripts \
    zabbix-agent2

# Verificar vers√µes instaladas
zabbix_proxy --version
zabbix_agent2 --version
```

## üóÑÔ∏è Configura√ß√£o do Banco de Dados

### Configurar MySQL para Zabbix Proxy

```bash
# Acessar MySQL como root
sudo mysql -u root -p
```

### Criar Banco e Usu√°rio para Proxy

```sql
-- Criar banco de dados com charset correto
CREATE DATABASE zabbix_proxy CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;

-- Criar usu√°rio espec√≠fico para o proxy
-- ‚ö†Ô∏è SUBSTITUA 'SuaSenhaSeguraAqui' por uma senha forte
CREATE USER 'zabbix_proxy'@'localhost' IDENTIFIED BY '@dmin123';

-- Conceder privil√©gios necess√°rios
GRANT ALL PRIVILEGES ON zabbix_proxy.* TO 'zabbix_proxy'@'localhost';

-- Aplicar mudan√ßas
FLUSH PRIVILEGES;

-- Verificar cria√ß√£o
SHOW DATABASES LIKE 'zabbix_proxy';
SELECT User, Host FROM mysql.user WHERE User = 'zabbix_proxy';

-- Sair do MySQL
EXIT;
```

### Importar Schema do Zabbix Proxy

```bash
# Importar schema inicial do Zabbix Proxy
cat /usr/share/zabbix-sql-scripts/mysql/proxy.sql | mysql --default-character-set=utf8mb4 -uzabbix_proxy -p zabbix_proxy

# Verificar importa√ß√£o
mysql -u zabbix_proxy -p zabbix_proxy -e "SHOW TABLES;"
```

### Otimizar Configura√ß√£o do MySQL

```bash
# Backup da configura√ß√£o original
sudo cp /etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/mysqld.cnf.backup

# Editar configura√ß√£o
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

Adicionar as seguintes configura√ß√µes na se√ß√£o **[mysqld]**:

```ini
[mysqld]
# Configura√ß√µes de performance
innodb_buffer_pool_size = 512M          # 50-70% da RAM dispon√≠vel
innodb_log_file_size = 64M
innodb_log_buffer_size = 16M
innodb_flush_log_at_trx_commit = 2       # Performance vs. durabilidade
innodb_flush_method = O_DIRECT

# Configura√ß√µes de conex√£o
max_connections = 200
wait_timeout = 28800
interactive_timeout = 28800

# Configura√ß√µes de log para troubleshooting
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# Configura√ß√µes de charset
character-set-server = utf8mb4
collation-server = utf8mb4_bin

# Configura√ß√µes de seguran√ßa
bind-address = 127.0.0.1                # Apenas conex√µes locais
```

### Reiniciar MySQL

```bash
# Reiniciar MySQL para aplicar configura√ß√µes
sudo systemctl restart mysql
sudo systemctl enable mysql

# Verificar status
sudo systemctl status mysql
```

## ‚öôÔ∏è Configura√ß√£o do Zabbix Proxy

### Editar Configura√ß√£o Principal

```bash
# Backup da configura√ß√£o original
sudo cp /etc/zabbix/zabbix_proxy.conf /etc/zabbix/zabbix_proxy.conf.backup

# Editar configura√ß√£o
sudo nano /etc/zabbix/zabbix_proxy.conf
```

### Configura√ß√µes Obrigat√≥rias

```ini
# === CONFIGURA√á√ïES B√ÅSICAS ===
ProxyMode=0                              # 0=ativo, 1=passivo
Server=IP_DO_ZABBIX_SERVER              # ‚ö†Ô∏è SUBSTITUIR pelo IP real
ServerPort=10051
Hostname=NOME_DO_PROXY                  # ‚ö†Ô∏è SUBSTITUIR por nome √∫nico

# === CONFIGURA√á√ïES DE REDE ===
ListenPort=10051
ListenIP=0.0.0.0

# === CONFIGURA√á√ïES DO BANCO DE DADOS ===
DBHost=localhost
DBName=zabbix_proxy
DBUser=zabbix_proxy
DBPassword=SuaSenhaSeguraAqui           # ‚ö†Ô∏è SUBSTITUIR pela senha real
DBPort=3306
DBSocket=/var/run/mysqld/mysqld.sock

# === CONFIGURA√á√ïES DE PERFORMANCE ===
StartPollers=10                         # Processos para coleta de dados
StartPollersUnreachable=2               # Processos para hosts inalcan√ß√°veis
StartTrappers=5                         # Processos para trapper items
StartPingers=1                          # Processos para ping ICMP
StartDiscoverers=1                      # Processos para descoberta
StartHTTPPollers=1                      # Processos para monitoramento HTTP

# === CONFIGURA√á√ïES DE CACHE ===
CacheSize=64M                           # Cache de configura√ß√£o
HistoryCacheSize=32M                    # Cache de hist√≥rico
HistoryIndexCacheSize=8M                # Cache de √≠ndice de hist√≥rico
TrendCacheSize=8M                       # Cache de tend√™ncias
ValueCacheSize=16M                      # Cache de valores

# === CONFIGURA√á√ïES DE TIMEOUT ===
Timeout=4                               # Timeout para opera√ß√µes de rede
TrapperTimeout=300                      # Timeout para trappers
UnreachablePeriod=45                    # Per√≠odo para host inalcan√ß√°vel
UnavailableDelay=60                     # Delay para host indispon√≠vel
UnreachableDelay=15                     # Delay para re-verifica√ß√£o

# === CONFIGURA√á√ïES DE LOG ===
LogFile=/var/log/zabbix/zabbix_proxy.log
LogFileSize=10                          # Tamanho m√°ximo em MB
DebugLevel=3                            # 0-5 (fatal a trace)

# === CONFIGURA√á√ïES DE SINCRONIZA√á√ÉO ===
ProxyLocalBuffer=0                      # Buffer local (0=desabilitado)
ProxyOfflineBuffer=24                   # Horas de buffer offline
HeartbeatFrequency=60                   # Frequ√™ncia de heartbeat
ConfigFrequency=600                     # Frequ√™ncia de config (10 min)
DataSenderFrequency=1                   # Frequ√™ncia de envio de dados
LogRemoteCommands=1                     # Habilitar comandos remotos
```

### Configurar Permiss√µes

```bash
# Criar diret√≥rio de log
sudo mkdir -p /var/log/zabbix

# Configurar propriet√°rio e permiss√µes
sudo chown zabbix:zabbix /var/log/zabbix
sudo chown zabbix:zabbix /etc/zabbix/zabbix_proxy.conf
sudo chmod 640 /etc/zabbix/zabbix_proxy.conf
```

## üöÄ Inicializa√ß√£o dos Servi√ßos

### Iniciar e Habilitar Servi√ßos

```bash
# Reiniciar todos os servi√ßos
sudo systemctl restart zabbix-proxy zabbix-agent2 mysql

# Habilitar inicializa√ß√£o autom√°tica
sudo systemctl enable zabbix-proxy zabbix-agent2 mysql

# Verificar status
sudo systemctl status zabbix-proxy zabbix-agent2 mysql
```

## ‚úÖ Verifica√ß√µes P√≥s-Instala√ß√£o

### Status dos Servi√ßos

```bash
# Status detalhado dos servi√ßos
sudo systemctl status zabbix-proxy --no-pager -l
sudo systemctl status mysql --no-pager -l
sudo systemctl status zabbix-agent2 --no-pager -l
```

### Verificar Logs do Proxy

```bash
# Monitorar logs em tempo real
sudo tail -f /var/log/zabbix/zabbix_proxy.log

# Verificar √∫ltimas 50 linhas
sudo tail -50 /var/log/zabbix/zabbix_proxy.log

# Buscar por erros
sudo grep -i error /var/log/zabbix/zabbix_proxy.log
```

### Testar Conectividade

```bash
# Verificar portas em uso
sudo ss -tulpn | grep -E "(10051|3306)"

# Testar conex√£o com MySQL
mysql -u zabbix_proxy -p -e "SELECT VERSION();" zabbix_proxy

# Testar conectividade com Zabbix Server
# ‚ö†Ô∏è SUBSTITUIR IP_DO_ZABBIX_SERVER
telnet IP_DO_ZABBIX_SERVER 10051
```

### Verificar Configura√ß√£o

```bash
# Testar sintaxe da configura√ß√£o
sudo zabbix_proxy -c /etc/zabbix/zabbix_proxy.conf -t

# Verificar processos em execu√ß√£o
ps aux | grep zabbix_proxy
```

## üîó Configura√ß√£o no Zabbix Server

### Adicionar Proxy na Interface Web

1. **Acesse a interface web do Zabbix Server**
   - URL: `http://IP_DO_ZABBIX_SERVER`

2. **Navegue para Administration > Proxies**

3. **Clique em \"Create proxy\"**

4. **Configure os seguintes par√¢metros:**
   - **Proxy name**: `NOME_DO_PROXY` (mesmo nome do arquivo de configura√ß√£o)
   - **Proxy mode**: `Active`
   - **Proxy address**: (deixe vazio para proxy ativo)
   - **Description**: `Proxy Ubuntu 24.04 + MySQL`

5. **Clique em \"Add\"**

### Verificar Status do Proxy

```bash
# Verificar comunica√ß√£o com o server
sudo grep -i "sending heartbeat" /var/log/zabbix/zabbix_proxy.log

# Verificar recebimento de configura√ß√£o
sudo grep -i "received configuration" /var/log/zabbix/zabbix_proxy.log

# Verificar sincroniza√ß√£o de dados
sudo grep -i "sending data" /var/log/zabbix/zabbix_proxy.log
```

## üî• Configura√ß√£o de Firewall

### Configurar UFW (Ubuntu Firewall)

```bash
# ‚ö†Ô∏è IMPORTANTE: Configurar SSH antes de habilitar UFW
sudo ufw allow ssh

# Habilitar UFW
sudo ufw enable

# Permitir comunica√ß√£o do proxy com o server (sa√≠da)
sudo ufw allow out 10051/tcp

# Permitir agentes se conectarem ao proxy (entrada)
sudo ufw allow 10051/tcp

# Permitir MySQL apenas localmente
sudo ufw allow from 127.0.0.1 to any port 3306

# Verificar regras configuradas
sudo ufw status verbose
```

## üìä Monitoramento e Troubleshooting

### Comandos √öteis para Diagn√≥stico

```bash
# Status detalhado do zabbix-proxy
sudo systemctl status zabbix-proxy -l

# Monitorar logs em tempo real
sudo journalctl -u zabbix-proxy -f

# Verificar uso de recursos
top -p $(pgrep zabbix_proxy | tr '\n' ',')

# Verificar conex√µes de rede
sudo ss -tulpn | grep 10051

# Verificar espa√ßo em disco
df -h /var/log/zabbix/
```

### Principais Problemas e Solu√ß√µes

| Problema | Poss√≠vel Causa | Solu√ß√£o |
|----------|----------------|---------|
| Proxy n√£o conecta ao Server | Firewall/IP incorreto | Verificar UFW e conectividade |
| Erro de banco MySQL | Credenciais incorretas | Verificar DBUser/DBPassword |
| Alto uso de CPU | Cache insuficiente | Aumentar CacheSize |
| Logs com erro de timeout | Timeout muito baixo | Aumentar Timeout |
| MySQL lento | Configura√ß√£o n√£o otimizada | Ajustar innodb_buffer_pool_size |

### Script de Monitoramento

```bash
#!/bin/bash
# Script para monitoramento do Zabbix Proxy

echo "=== Status dos Servi√ßos ==="
sudo systemctl is-active zabbix-proxy mysql zabbix-agent2

echo -e "\n=== Uso de Recursos ==="
echo "CPU e Mem√≥ria dos processos Zabbix:"
ps aux | grep zabbix | grep -v grep

echo -e "\n=== Conectividade ==="
echo "Portas em uso:"
sudo ss -tulpn | grep -E "(10051|3306)"

echo -e "\n=== Status do MySQL ==="
mysql -u zabbix_proxy -p -e "
SELECT 
    VARIABLE_NAME, 
    VARIABLE_VALUE 
FROM INFORMATION_SCHEMA.GLOBAL_STATUS 
WHERE VARIABLE_NAME IN (
    'Threads_connected',
    'Queries',
    'Slow_queries',
    'Uptime'
);" 2>/dev/null

echo -e "\n=== Tamanho do Banco ==="
mysql -u zabbix_proxy -p zabbix_proxy -e "
SELECT 
    TABLE_NAME,
    ROUND(((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024), 2) AS 'Size (MB)'
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_SCHEMA = 'zabbix_proxy'
ORDER BY (DATA_LENGTH + INDEX_LENGTH) DESC
LIMIT 5;" 2>/dev/null
```

## üõ†Ô∏è Manuten√ß√£o

### Script de Backup

```bash
#!/bin/bash
# Script de backup automatizado

BACKUP_DIR="/backup/zabbix-proxy"
DATE=$(date +%Y%m%d_%H%M%S)
DB_USER="zabbix_proxy"
DB_NAME="zabbix_proxy"

# Criar diret√≥rio de backup
mkdir -p "$BACKUP_DIR"

echo "Iniciando backup do Zabbix Proxy..."

# Backup do banco de dados
echo "Fazendo backup do banco de dados..."
mysqldump -u "$DB_USER" -p "$DB_NAME" > "$BACKUP_DIR/zabbix_proxy_db_$DATE.sql"
gzip "$BACKUP_DIR/zabbix_proxy_db_$DATE.sql"

# Backup da configura√ß√£o
echo "Fazendo backup da configura√ß√£o..."
cp /etc/zabbix/zabbix_proxy.conf "$BACKUP_DIR/zabbix_proxy_conf_$DATE.conf"

# Limpeza de backups antigos (manter 7 dias)
echo "Removendo backups antigos..."
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +7 -delete
find "$BACKUP_DIR" -name "*.conf" -mtime +7 -delete

echo "Backup conclu√≠do em: $BACKUP_DIR"
```

#### Automatizar via cron:
```bash
# Editar crontab
sudo crontab -e

# Adicionar linha para backup di√°rio √†s 2h
0 2 * * * /path/to/backup_script.sh
```

### Configurar Logrotate

```bash
# Criar configura√ß√£o de logrotate
sudo nano /etc/logrotate.d/zabbix-proxy
```

```bash
/var/log/zabbix/zabbix_proxy.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 zabbix zabbix
    postrotate
        /bin/systemctl reload zabbix-proxy > /dev/null 2>&1 || true
    endscript
}
```

### Comandos de Manuten√ß√£o

```bash
# Verificar tamanho do banco
mysql -u zabbix_proxy -p zabbix_proxy -e "
SELECT 
    ROUND(SUM(DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024, 2) AS 'DB Size (MB)' 
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_SCHEMA = 'zabbix_proxy';"

# Reiniciar apenas o proxy
sudo systemctl restart zabbix-proxy

# Verificar configura√ß√£o sem reiniciar
sudo zabbix_proxy -c /etc/zabbix/zabbix_proxy.conf -t

# Monitorar performance em tempo real
watch -n 5 'ps aux | grep zabbix_proxy | grep -v grep'
```

## üìö Refer√™ncias

- [Documenta√ß√£o Oficial Zabbix 7.0](https://www.zabbix.com/documentation/7.0/)
- [Zabbix Proxy Documentation](https://www.zabbix.com/documentation/7.0/en/manual/concepts/proxy)
- [MySQL 8.0 Documentation](https://dev.mysql.com/doc/refman/8.0/en/)
- [Ubuntu Server 24.04 LTS Documentation](https://ubuntu.com/server/docs)

---

**‚úÖ Instala√ß√£o Conclu√≠da!**

O Zabbix Proxy 7.0 LTS com MySQL no Ubuntu Server 24.04 LTS est√° pronto para coletar dados e sincronizar com o Zabbix Server central.

> **üí° Dica**: Monitore os logs regularmente e ajuste as configura√ß√µes conforme necess√°rio para otimizar a performance.
